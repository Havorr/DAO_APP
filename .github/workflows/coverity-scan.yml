name: Coverity Scan (CMake C++)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  coverity:
    runs-on: ubuntu-latest

    env:
      PROJECT_DIR: A-hello-cmake
      COVERITY_PROJECT: DAO_APP
      BUILD_VERSION: "1.0.${{ github.run_number }}"
      BUILD_DESCRIPTION: "GitHub Actions Coverity Scan"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake curl tar gzip

      - name: Download Coverity Analysis Tool
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${COVERITY_SCAN_TOKEN:-}" ]; then
            echo "ERROR: COVERITY_SCAN_TOKEN is empty. Check repo secrets or workflow context."
            exit 1
          fi

          echo "Downloading Coverity tool for project: ${COVERITY_PROJECT}"

          curl -fL -X POST \
            --data-urlencode "token=${COVERITY_SCAN_TOKEN}" \
            --data-urlencode "project=${COVERITY_PROJECT}" \
            https://scan.coverity.com/download/linux64 \
            -o coverity.tgz

          mkdir -p coverity
          tar -xzf coverity.tgz -C coverity --strip 1
          ls -la coverity/bin

      - name: Build with Coverity (capture)
        run: |
          set -euo pipefail
          cd "${PROJECT_DIR}"
          mkdir -p build
          cd build

          ../../coverity/bin/cov-build --dir cov-int cmake ..
          ../../coverity/bin/cov-build --dir cov-int make -j"$(nproc)"

          test -d cov-int
          echo "cov-int created OK."

      - name: Pack results (cov-int)
        run: |
          set -euo pipefail
          cd "${PROJECT_DIR}/build"
          tar -czf cov-int.tgz cov-int
          ls -lh cov-int.tgz

      - name: Uploading to Coverity Scan
        env:
        COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        COVERITY_SCAN_EMAIL: ${{ secrets.COVERITY_SCAN_EMAIL }}
        COVERITY_PROJECT: DAO_APP
        RESULT_TGZ: ${{ github.workspace }}/coverity-results.tgz
        run: |
          set -euo pipefail

        # URL-encode nazwy projektu (ważne, jeśli jest np. owner/repo)
           PROJECT_ENC=$(python - <<'PY'
          import os, urllib.parse
        print(urllib.parse.quote(os.environ["COVERITY_PROJECT"], safe=""))
        PY
    )

    curl -fLsS \
      --form token="${COVERITY_SCAN_TOKEN}" \
      --form email="${COVERITY_SCAN_EMAIL}" \
      --form file=@"${RESULT_TGZ}" \
      --form version="${GITHUB_SHA}" \
      --form description="GitHub Actions build ${GITHUB_RUN_NUMBER}" \
      "https://scan.coverity.com/builds?project=${PROJECT_ENC}"


