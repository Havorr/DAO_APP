name: Coverity Scan (CMake C++)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  coverity:
    runs-on: ubuntu-latest

    env:
      # Folder z Twoim projektem CMake
      PROJECT_DIR: A-hello-cmake

      # MUSI być dokładnie taka sama nazwa projektu jak na scan.coverity.com
      COVERITY_PROJECT: test_app

      # Opcjonalnie: wersja/opis builda widoczny w Coverity
      BUILD_VERSION: "1.0.${{ github.run_number }}"
      BUILD_DESCRIPTION: "GitHub Actions Coverity Scan"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake curl tar gzip

      - name: Download Coverity Analysis Tool
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        run: |
          set -euo pipefail

          curl -fL -X POST \
            --data "token=${COVERITY_SCAN_TOKEN}&project=${COVERITY_PROJECT}" \
            https://scan.coverity.com/download/linux64 \
            -o coverity.tgz

          mkdir -p coverity
          tar -xzf coverity.tgz -C coverity --strip 1

          echo "Coverity tool downloaded."
          ls -la coverity/bin | head -n 50

      - name: Build with Coverity (capture)
        run: |
          set -euo pipefail

          cd "${PROJECT_DIR}"
          mkdir -p build
          cd build

          ../../coverity/bin/cov-build --dir cov-int cmake ..
          ../../coverity/bin/cov-build --dir cov-int make -j"$(nproc)"

          test -d cov-int
          echo "cov-int created OK."

      - name: Pack results (cov-int)
        run: |
          set -euo pipefail

          cd "${PROJECT_DIR}/build"
          tar -czf cov-int.tgz cov-int
          ls -lh cov-int.tgz

      - name: Upload to Coverity Scan
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
          COVERITY_SCAN_EMAIL: ${{ secrets.COVERITY_SCAN_EMAIL }}
        run: |
          set -euo pipefail

          cd "${PROJECT_DIR}/build"

          curl -fL -X POST \
            --form "token=${COVERITY_SCAN_TOKEN}" \
            --form "email=${COVERITY_SCAN_EMAIL}" \
            --form "file=@cov-int.tgz" \
            --form "version=${BUILD_VERSION}" \
            --form "description=${BUILD_DESCRIPTION}" \
            https://scan.coverity.com/builds
