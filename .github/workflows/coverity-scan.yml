name: Coverity Scan (Python) - DAO_APP

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  coverity:
    runs-on: ubuntu-latest

    env:
      # Ustaw nazwę projektu taką, jaką masz w Coverity Scan.
      # Jeśli Coverity Scan ma projekt w formie owner/repo, ustaw:
      # COVERITY_PROJECT: ${{ github.repository }}
      COVERITY_PROJECT: DAO_APP

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if requirements.txt exists)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found - skipping pip install."
          fi

      - name: Download Coverity Tool (Linux 64-bit)
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        run: |
          set -euo pipefail

          echo "Downloading Coverity tool for project: ${COVERITY_PROJECT}"
          curl -fL \
            -X POST \
            --data "token=${COVERITY_SCAN_TOKEN}&project=${COVERITY_PROJECT}" \
            https://scan.coverity.com/download/linux64 \
            -o coverity-tool.tgz

          mkdir -p coverity
          tar -xzf coverity-tool.tgz -C coverity --strip 1

          echo "Coverity tool downloaded:"
          ls -la coverity/bin | head -n 50

      - name: Run Coverity capture (Python)
        run: |
          set -euo pipefail
          export PATH="${GITHUB_WORKSPACE}/coverity/bin:$PATH"

          # W projektach Pythona nie ma klasycznego "build".
          # Najprostsze sensowne "capture" to kompilacja bytecode całego repo.
          rm -rf cov-int
          cov-build --dir cov-int python -m compileall -q .

          echo "cov-int size:"
          du -sh cov-int || true

          tar -czf coverity-results.tgz cov-int

      - name: Upload to Coverity Scan
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
          COVERITY_SCAN_EMAIL: ${{ secrets.COVERITY_SCAN_EMAIL }}
        run: |
          set -euo pipefail

          # URL-encode nazwy projektu (ważne, jeśli jest owner/repo)
          PROJECT_ENC=$(python - <<'PY'
import os, urllib.parse
print(urllib.parse.quote(os.environ["COVERITY_PROJECT"], safe=""))
PY
          )

          echo "Uploading to Coverity Scan"
          echo "Project: ${COVERITY_PROJECT}"

          curl -fLsS \
            --form token="${COVERITY_SCAN_TOKEN}" \
            --form email="${COVERITY_SCAN_EMAIL}" \
            --form file=@"coverity-results.tgz" \
            --form version="${GITHUB_SHA}" \
            --form description="GitHub Actions build ${GITHUB_RUN_NUMBER}" \
            "https://scan.coverity.com/builds?project=${PROJECT_ENC}"
