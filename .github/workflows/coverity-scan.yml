name: Coverity Scan (Python) - DAO_APP

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  coverity:
    runs-on: ubuntu-latest

    env:
      # Jeśli Coverity Scan ma projekt jako owner/repo, ustaw:
      # COVERITY_PROJECT: ${{ github.repository }}
      COVERITY_PROJECT: DAO_APP

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (optional)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found - skipping pip install."
          fi

      - name: Download Coverity Tool (Linux 64-bit) to RUNNER_TEMP
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        run: |
          set -euo pipefail

          echo "Downloading Coverity tool for project: ${COVERITY_PROJECT}"
          curl -fL \
            -X POST \
            --data "token=${COVERITY_SCAN_TOKEN}&project=${COVERITY_PROJECT}" \
            https://scan.coverity.com/download/linux64 \
            -o coverity-tool.tgz

          mkdir -p "${RUNNER_TEMP}/coverity"
          tar -xzf coverity-tool.tgz -C "${RUNNER_TEMP}/coverity" --strip 1

          echo "Coverity tool downloaded (first entries):"
          ls -la "${RUNNER_TEMP}/coverity/bin" | sed -n '1,50p'

      - name: Capture sources (filesystem capture for Python)
        run: |
          set -euo pipefail
          export PATH="${RUNNER_TEMP}/coverity/bin:$PATH"

          rm -rf cov-int

          # Filesystem capture: łapie źródła (np. .py) bez "buildowania"
          # UWAGA: capture robimy z katalogu repo, ale narzędzia Coverity są w RUNNER_TEMP,
          # więc nie wpadną do skanowania.
          cov-build --dir cov-int --fs-capture-search . true

          # Debug: pokaż, czy coś w ogóle zostało złapane
          echo "Captured files count:"
          find cov-int -maxdepth 3 -type f | wc -l || true

          tar -czf coverity-results.tgz cov-int
          ls -lah coverity-results.tgz

      - name: Upload to Coverity Scan
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
          COVERITY_SCAN_EMAIL: ${{ secrets.COVERITY_SCAN_EMAIL }}
        run: |
          set -euo pipefail

          PROJECT_ENC="$(python -c 'import os,urllib.parse; print(urllib.parse.quote(os.environ["COVERITY_PROJECT"], safe=""))')"

          echo "Uploading to Coverity Scan"
          echo "Project: ${COVERITY_PROJECT}"

          curl -fLsS \
            --form token="${COVERITY_SCAN_TOKEN}" \
            --form email="${COVERITY_SCAN_EMAIL}" \
            --form file=@"coverity-results.tgz" \
            --form version="${GITHUB_SHA}" \
            --form description="GitHub Actions build ${GITHUB_RUN_NUMBER}" \
            "https://scan.coverity.com/builds?project=${PROJECT_ENC}"
