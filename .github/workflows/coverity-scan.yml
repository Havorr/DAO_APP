name: Coverity Scan (Python) - DAO_APP

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  coverity:
    runs-on: ubuntu-latest

    env:
      # Jeśli Coverity Scan ma projekt jako owner/repo, ustaw to tak:
      # COVERITY_PROJECT: ${{ github.repository }}
      COVERITY_PROJECT: DAO_APP

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (optional)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found - skipping pip install."
          fi

      - name: Download Coverity Tool (Linux 64-bit)
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        run: |
          set -euo pipefail

          echo "Downloading Coverity tool for project: ${COVERITY_PROJECT}"
          curl -fL \
            -X POST \
            --data "token=${COVERITY_SCAN_TOKEN}&project=${COVERITY_PROJECT}" \
            https://scan.coverity.com/download/linux64 \
            -o coverity-tool.tgz

          mkdir -p coverity
          tar -xzf coverity-tool.tgz -C coverity --strip 1

          echo "Coverity tool downloaded (first entries):"
          ls -la coverity/bin | sed -n '1,50p'


      - name: Run Coverity capture (Python)
        run: |
          set -euo pipefail
          export PATH="${GITHUB_WORKSPACE}/coverity/bin:$PATH"

          rm -rf cov-int

          # Kompiluj repo, ale ignoruj foldery z narzędziami Coverity i artefakty
          cov-build --dir cov-int python -m compileall -q \
            -x '(^|/)(coverity|cov-int|\.git|\.venv|venv|__pycache__|dist|build)(/|$)' \
            .

          tar -czf coverity-results.tgz cov-int
          ls -lah coverity-results.tgz


      - name: Upload to Coverity Scan
        env:
          COVERITY_SCAN_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
          COVERITY_SCAN_EMAIL: ${{ secrets.COVERITY_SCAN_EMAIL }}
        run: |
          set -euo pipefail

          # URL-encode nazwy projektu (ważne jeśli np. owner/repo)
          PROJECT_ENC="$(python -c 'import os,urllib.parse; print(urllib.parse.quote(os.environ["COVERITY_PROJECT"], safe=""))')"

          echo "Uploading to Coverity Scan"
          echo "Project: ${COVERITY_PROJECT}"

          curl -fLsS \
            --form token="${COVERITY_SCAN_TOKEN}" \
            --form email="${COVERITY_SCAN_EMAIL}" \
            --form file=@"coverity-results.tgz" \
            --form version="${GITHUB_SHA}" \
            --form description="GitHub Actions build ${GITHUB_RUN_NUMBER}" \
            "https://scan.coverity.com/builds?project=${PROJECT_ENC}"
